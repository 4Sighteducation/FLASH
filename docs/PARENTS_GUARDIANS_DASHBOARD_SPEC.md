# Parents / Guardians dashboard (in-app) — scope + technical spec

## Product goals (confirmed)
- **Guardian has their own login** (Supabase auth user).
- **Guardian can see card content** (flashcards Q/A etc) for linked children.
- **Many children per guardian**.
- **Max 2 guardians per child** (enforced).
- Child can **revoke** access at any time.

## Non-goals (for MVP)
- No editing/deleting child cards by guardians (read-only).
- No external payment links in the app (Apple compliance). Parent/guardian payments remain on marketing site.

## Existing building blocks we can reuse
- **Portfolio data**: `public.flashcards` + `public.card_reviews` (used throughout `src/screens/cards/*`).
- **Daily stats**: `public.user_daily_study_stats_mv` + RPC `public.get_user_daily_study_stats(p_limit)` (currently filters to `auth.uid()`).
- **Streak / totals**: `public.user_stats`.
- **“Invite parent/guardian”** currently exists but is for payment flow (SendGrid email → marketing `/parents`).

## Core concept: explicit guardian↔child links
We introduce a new linking system that is separate from payment/subscription claims.

### Tables
#### `public.guardian_child_links`
Represents an access relationship.

Suggested columns:
- `id uuid pk default gen_random_uuid()`
- `created_at timestamptz not null default now()`
- `updated_at timestamptz not null default now()`
- `child_user_id uuid not null references auth.users(id) on delete cascade`
- `guardian_user_id uuid not null references auth.users(id) on delete cascade`
- `status text not null default 'active' check (status in ('active','revoked'))`
- `can_view_card_content boolean not null default true`
- `revoked_at timestamptz null`
- `revoked_by uuid null references auth.users(id) on delete set null`

Indexes / constraints:
- Unique relationship: `unique(child_user_id, guardian_user_id)`
- Fast lookup: indexes on `(child_user_id)`, `(guardian_user_id)`, `(child_user_id, status)`, `(guardian_user_id, status)`

#### `public.guardian_link_codes`
One-time (or limited use) codes generated by the child and redeemed by the guardian.

Suggested columns:
- `id uuid pk default gen_random_uuid()`
- `created_at timestamptz not null default now()`
- `child_user_id uuid not null references auth.users(id) on delete cascade`
- `code_hash text not null unique` (store hash, not raw code)
- `expires_at timestamptz not null` (e.g. now() + 24 hours)
- `redeemed_at timestamptz null`
- `redeemed_by uuid null references auth.users(id) on delete set null`
- `max_uses int not null default 1`
- `uses int not null default 0`

Notes:
- Store **hash** to reduce risk if database is exposed.
- Codes should be short enough to type but high entropy (e.g. 10–12 chars base32).

## Enforcing “max 2 guardians per child”
We should enforce this server-side in the redeem function (and optionally with a DB trigger).

**Primary enforcement (recommended):**
- In `redeem_guardian_link_code(...)` RPC:
  - count active guardians for `child_user_id`
  - if `>= 2`, reject with a clear error

Optional hard enforcement:
- Trigger on `guardian_child_links` insert/update to prevent >2 active links. (More complex; the RPC check usually suffices.)

## Security model (RLS + RPC)
We want guardians to read child data **only if** there is an active link.

### RLS principles
- Keep existing “user can see own rows” rules.
- Add **read-only select policies** for guardians on child rows.
- Do **not** allow guardians to insert/update/delete child flashcards or reviews.

### RLS policies to add
#### `public.flashcards` (SELECT only for guardians)
Allow `SELECT` where:
- `auth.uid() = user_id` (existing), OR
- exists an active link:
  - `guardian_child_links.child_user_id = flashcards.user_id`
  - `guardian_child_links.guardian_user_id = auth.uid()`
  - `guardian_child_links.status = 'active'`
  - `guardian_child_links.can_view_card_content = true`

#### `public.card_reviews` (optional for MVP)
If we want guardians to see per-card history, add a similar SELECT policy.
If we only show aggregates, we can skip this for MVP and rely on stats RPCs.

#### `public.user_stats` (SELECT for guardians)
Allow SELECT for linked guardians (status=active).

### Stats RPCs (needed because current RPC filters to auth.uid)
Create new SECURITY DEFINER RPCs that return aggregated stats for a specific child, but only if caller is a linked guardian.

Suggested functions:
- `public.guardian_list_children()`
  - returns child ids + display names + last seen + basic totals
- `public.guardian_get_child_daily_study_stats(p_child_user_id uuid, p_limit int default 60)`
  - returns rows from `user_daily_study_stats_mv` filtered to `p_child_user_id`
  - access check: caller must be linked guardian OR the child themself

Implementation note:
- Use `SECURITY DEFINER` with `SET search_path = public`.
- Always do authorization check inside the function:
  - `exists(select 1 from guardian_child_links where child_user_id=p_child_user_id and guardian_user_id=auth.uid() and status='active')`

## Linking UX (in app)
### Student flow (child account)
- Profile → **Parent/Guardian access**
  - “Generate link code” (shows code + expiry + copy button)
  - List of guardians (email/username if available), with “Revoke”
  - (Optional) toggle “Allow card content” (on by default)

### Guardian flow
- Guardian signs up / signs in (normal auth)
- Profile → **Add child**
  - Enter link code
  - On success, child appears in **Children** list

## Parents/Guardians dashboard UX (in app)
### Screen 1: Children list
- Shows each linked child:
  - display name
  - last active (can be approximated via user_stats.updated_at / a “last_seen” column if present)
  - streak
  - 7d accuracy + reviews (from MV via RPC)

### Screen 2: Child overview
- KPI tiles:
  - current streak
  - 7d/30d reviews
  - 7d/30d accuracy
  - XP earned (7d/30d)
- Chart: daily reviews + accuracy from MV
- “Portfolio” entry: Subjects / topics summary (counts + due + mastered)

### Screen 3: Portfolio (card content)
- Browse by subject → topic → flashcards list
- Each card row:
  - question preview
  - box number / due date
  - (optional) success rate / last reviewed
- Card detail:
  - full question/answer/options/key points
  - (optional) recent review history

## Implementation plan (phased)
### Phase 1 — Linking + overview stats (fast path)
- DB migration: add `guardian_child_links`, `guardian_link_codes`
- RPC: `create_guardian_link_code` (child) + `redeem_guardian_link_code` (guardian) + `guardian_get_child_daily_study_stats`
- UI: Student “Generate code” + Guardian “Redeem code”
- Dashboard: child picker + stats overview (no portfolio browsing yet)

### Phase 2 — Portfolio with card content
- Add RLS SELECT policy on `flashcards` for guardians
- UI reuse: adapt existing `FlashcardsScreen` to accept an optional `effectiveUserId` (child) in guardian mode
- Add subject/topic browsing for guardians

### Phase 3 — Polishing + safeguards
- Enforce max-2 guardians with optional trigger (if needed)
- Audit log table (who linked/unlinked)
- Optional notifications: weekly digest to guardians

## Open questions (to confirm before building)
- Should linking be **child-initiated only** (recommended), or can guardians request access?
- Do we require the child to explicitly “approve” after a guardian redeems a code, or is code possession sufficient consent?
- Should guardians be able to see **review history** (`card_reviews`) or only summarized metrics?

